{% extends "base.html" %}
{% load static %}

{% block content %}

<!-- Results Archive -->
<div class="container">
    <h1>Results Archive for {{ horse.name }}</h1>

    {% if results %}

    <div class="filters">
        <label for="sortResults">Sort by:</label>
        <select id="sortResults">
            <option value="date">Date (Newest First)</option>
            <option value="date_asc">Date (Oldest First)</option>
            <option value="title">Title (A-Z)</option>
            <option value="title_desc">Title (Z-A)</option>
            <option value="height">Jump Height (Highest First)</option>
            <option value="height_asc">Jump Height (Lowest First)</option>
        </select>
    
        <label for="filterMonth">Filter by:</label>
        <select id="filterMonth">
            <option value="all">All Time</option>
            <option value="this_month">This Month</option>
            <option value="this_year">This Year</option>
            <option value="last_6">Last 6 Months</option>
        </select>
    </div>
    

        <ul id="resultsList">
            {% for result in results %}
    <li class="result-item"
        data-date="{{ result.event.start_time|date:'Y-m-d' }}"
        data-title="{{ result.event.title }}"
        data-height="{{ result.jump_height|default:0 }}">
        <strong>{{ result.event.title }}</strong><br>
        Date: {{ result.event.start_time|date:"Y-m-d" }}<br>
        Class Details: {{ result.class_details }}<br>
        Height: {{ result.jump_height_str }}<br>
        Faults: {{ result.number_of_faults }}<br>
        Notes: {{ result.results|default:"No results yet" }}<br>

        <!-- Display Performance Rating with SVG Stars -->
        Performance Rating:
        {% if result.performance_rating %}
            {% with result.performance_rating|add:"0" as rating %}
                {% for i in "12345" %}
                    <svg height="20" viewBox="0 0 576 512" class="{% if i|add:"0" <= rating %}star-{{ rating }}{% else %}star-empty{% endif %}">
                        <path d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"></path>
                    </svg>
                {% endfor %}
            {% endwith %}
        {% else %}
            Not Rated
        {% endif %}
    </li>
{% endfor %}

{% endif %} 

</div>

<!-- Performance Tracking Data -->
<div class="container">
    <h1>Performance Archive for {{ horse.name }}</h1>

    <!-- Chart Filters -->
    <div class="chart-filters">
        <div class="filter-group">
            <label><input type="radio" name="chartType" value="all" checked> All Metrics</label>
            <label><input type="radio" name="chartType" value="rating"> Performance Rating</label>
            <label><input type="radio" name="chartType" value="height"> Jump Height</label>
            <label><input type="radio" name="chartType" value="faults"> Faults</label>
        </div>

        <div class="filter-group">
            <label>Time Range:
                <select id="timeRange">
                    <option value="all">All Time</option>
                    <option value="1m">1 Month</option>
                    <option value="3m">3 Months</option>
                    <option value="6m">6 Months</option>
                </select>
            </label>
        </div>
    </div>

    <!-- Chart Canvas -->
    <canvas id="performanceChart" width="400" height="200"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let resultsList = document.getElementById("resultsList");
        let sortSelect = document.getElementById("sortResults");
        let filterSelect = document.getElementById("filterMonth");

        function sortResults() {
            let items = Array.from(resultsList.getElementsByClassName("result-item"));
            let sortValue = sortSelect.value;

            items.sort((a, b) => {
                let dateA = new Date(a.dataset.date);
                let dateB = new Date(b.dataset.date);
                let titleA = a.dataset.title.toLowerCase();
                let titleB = b.dataset.title.toLowerCase();
                let heightA = parseFloat(a.dataset.height);
                let heightB = parseFloat(b.dataset.height);

                if (sortValue === "date") return dateB - dateA;
                if (sortValue === "date_asc") return dateA - dateB;
                if (sortValue === "title") return titleA.localeCompare(titleB);
                if (sortValue === "title_desc") return titleB.localeCompare(titleA);
                if (sortValue === "height") return heightB - heightA;
                if (sortValue === "height_asc") return heightA - heightB;
            });

            resultsList.innerHTML = "";
            items.forEach(item => resultsList.appendChild(item));
        }

        function filterResults() {
            let items = Array.from(resultsList.getElementsByClassName("result-item"));
            let filterValue = filterSelect.value;
            let now = new Date();

            items.forEach(item => {
                let itemDate = new Date(item.dataset.date);
                let show = true;

                if (filterValue === "this_month") {
                    show = itemDate.getFullYear() === now.getFullYear() && itemDate.getMonth() === now.getMonth();
                } else if (filterValue === "this_year") {
                    show = itemDate.getFullYear() === now.getFullYear();
                } else if (filterValue === "last_6") {
                    let sixMonthsAgo = new Date();
                    sixMonthsAgo.setMonth(now.getMonth() - 6);
                    show = itemDate >= sixMonthsAgo;
                }

                item.style.display = show ? "block" : "none";
            });
        }

        sortSelect.addEventListener("change", sortResults);
        filterSelect.addEventListener("change", filterResults);

        sortResults();
    });






    document.addEventListener("DOMContentLoaded", function () {
        let rawData = {
            dates: [],
            ratings: [],
            jumpHeights: [],
            faults: []
        };

        {% for result in results %}
            rawData.dates.push("{{ result.event.start_time|date:'Y-m-d' }}");
            rawData.ratings.push({{ result.performance_rating|default:0 }});
            rawData.jumpHeights.push({{ result.jump_height|default:0 }});
            rawData.faults.push({{ result.number_of_faults|default:0 }});
        {% endfor %}

        let ctx = document.getElementById("performanceChart").getContext("2d");
        let chart;

        function filterData(timeRange) {
            let now = new Date();
            let filteredData = { dates: [], ratings: [], jumpHeights: [], faults: [] };

            rawData.dates.forEach((date, index) => {
                let eventDate = new Date(date);
                let withinRange = false;

                if (timeRange === "all") {
                    withinRange = true;
                } else if (timeRange === "1m" && eventDate >= new Date(now.setMonth(now.getMonth() - 1))) {
                    withinRange = true;
                } else if (timeRange === "3m" && eventDate >= new Date(now.setMonth(now.getMonth() - 3))) {
                    withinRange = true;
                } else if (timeRange === "6m" && eventDate >= new Date(now.setMonth(now.getMonth() - 6))) {
                    withinRange = true;
                }

                if (withinRange) {
                    filteredData.dates.push(date);
                    filteredData.ratings.push(rawData.ratings[index]);
                    filteredData.jumpHeights.push(rawData.jumpHeights[index]);
                    filteredData.faults.push(rawData.faults[index]);
                }
            });

            return filteredData;
        }

        function updateChart(chartType, timeRange) {
            let data = filterData(timeRange);
            let datasets = [];

            let labels = {
                "rating": "Performance Rating",
                "height": "Jump Height",
                "faults": "Faults"
            };
            let colors = {
                "rating": "blue",
                "height": "green",
                "faults": "red"
            };

            let dataKey;
            if (chartType === "height") {
                dataKey = "jumpHeights";
            } else if (chartType === "faults") {
                dataKey = "faults";
            } else {
                dataKey = chartType + "s";
            }

            if (chartType === "all") {
                datasets = [
                    { label: "Performance Rating", data: data.ratings, borderColor: "blue", fill: false },
                    { label: "Jump Height", data: data.jumpHeights, borderColor: "green", fill: false },
                    { label: "Faults", data: data.faults, borderColor: "red", fill: false },
                ];
            } else {
                datasets = [{
                    label: labels[chartType],
                    data: data[dataKey],
                    backgroundColor: colors[chartType]
                }];
            }

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: chartType === "all" ? "line" : "bar",
                data: { labels: data.dates, datasets },
            });
        }


        
        document.querySelectorAll('input[name="chartType"]').forEach(input => {
            input.addEventListener("change", () => updateChart(input.value, document.getElementById("timeRange").value));
        });

        document.getElementById("timeRange").addEventListener("change", (e) => {
            let selectedChart = document.querySelector('input[name="chartType"]:checked').value;
            updateChart(selectedChart, e.target.value);
        });

        updateChart("all", "all");
    });
</script>

{% endblock %}
